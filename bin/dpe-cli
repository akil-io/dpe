#!/usr/bin/env node
"use strict";

var debug   = require('debug')('dpe:cli');
var util = require('util');
var argv = require('optimist').argv;
var io = require('socket.io-client');
var path = require('path');
var fs  = require('fs');

var Service = require('../lib/service');
var s = new Service({
    init: false
});

var jsonSignal = {};

if (argv.file) {
    try {
        jsonSignal = JSON.parse(fs.readFileSync(path.resolve(argv.file), 'utf8'));
    } catch (e) {
        console.error('Can not parse signal');
        process.exit(1);
    }
}

if (argv._.length) {
    //@TODO: cli command
    console.error('Cli commands is not implemented');
    process.exit(1);
}

s.connect('http://localhost', s.get('cli.port'), {
    uid: "local",
    key: s.get('local.key')
}, (err, client) => {
    if (err) {
        console.error(err);
        process.exit(1);
    }

    client.onResponse(function (msg) {
        console.log("ECHO: ", util.inspect(msg, {depth:null,colors:true}));
        process.exit();
    });

    debug('connected  to http://localhost:' + s.get('cli.port'));
    debug('send', jsonSignal);
    client.request(jsonSignal);
});


