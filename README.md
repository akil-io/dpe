# DPE Framework - Data Process Engine

DPE Framework является уровнем абстракции над задачами деплоя и масштабирования сложных вычислительных процессов. Работает на базе Socket.IO.

Основные понятия:

1. DPE-узел - запущенный процесс, реализующий DPE API. Несколько связанных узлов образуют dpe-сеть. Сеть может быть развернута как в рамках одной ОС, так и быть распределенной между разными дата-центрами. Единственное требование - возможность установить связь используя вебсокеты. В рамках dpe-сети можно выделить два типа узлов: рабочие и центральные. Центральный узел отвечает за прием сигнала, построение плана исполнения и реализацию плана используя доступные ресурсы.

2. Компонент - JS-функция, стандартизированная для запуска на DPE-узле.
3. Ядро - набор компонент, с которым стартует DPE-узел. Обеспечивают базовые функциональные возможности сервиса. Ядро не может быть изменено после запуска узла. В данный момент, каждый DPE-узел стартует со стандартным встроенным ядром. Ядра станут заменяемыми к версии 1.5
4. Модуль - набор компонент, исполняющихся в рамках определенного ядра. Стандартное ядро содержит компоненты позволяющие загружать и выгружать модули. Рабочий узел сообщает каждому центральному узлу к которому он подключен информацию об установленных модулях.

В данный момент протокол DPE реализует одноименный пакет для Node.JS и расширение для Chrome.

## Словарь
1. Хост-сервис - обвязка для запуска и управления фоновым сервисом, который содержит в себе ядро и загруженные приложения.
1. Компонент - составная часть ядра и приложений, по сути каждая отдельная функция которая может быть вызвана из вне.
1. Ядро - набор связанных компонент исполняющихся в общем контексте, обеспечивающих базовые функциональные возможности сервиса и основной жизненный цикл приложения. Для работы требуется как минимум одно запущенное ядро. Ядра грузятся при инициализации ноды.
1. Модуль - зависимый от конкретного ядра набор функций определяющих бизнес-логику и выполняющих какие-то полезные действия. Грузятся после инициализации ноды.
1. Приложение - набор компонент исполняющихся с ограниченными правами (внутри песочницы с четко определенными возможностями и ограничениями)
1. Сигнал - запрос на исполнение функций в системе, представляет собой сериализованный в JSON объект, в котором каждый ключ это имя функции которую необходимо вызвать. Также содержит мета-данные начинающиеся с префикса _ и теги начинающиеся с префикса @.
1. Процесс - набор функций исполняющихся в определенном порядке для достижения некоторой цели в общем контексте исполнения.
1. Ресурс - объект данных в общем контексте процесса.

# Установка

Для начала работы следует установить nodejs-пакет, сконфигурировать его (создаться директория .dpe в домашнем каталоге пользователя) и запустить.

```bash 
npm install -g dpe 

dpe service configure

dpe service start
```


# Формат сигналов

Сигнал задается JSON-файлом и представляется собой словарь, в котором в качестве ключей используются названия методов (из ядер, модулей или приложений) и мета-информация, а в качестве значений - информация о параметрах и условия запуска.

## Запуск задачи с параметрами

Название параметра не может начинаться с символов '@' и '_' (чтобы не конфликтовать с тегами и мета-информацией)

```json
{
    "namespace1.task1": {
        "arg1": "Hello",
        "arg2": 42
    }
}
```

## Последовательный запуск нескольких задач
```json
{
    "task1": {},
    "task2": {},
    "task3": {}
}
```

Такой сигнал эквивалентен последовательному исполнению task1, task2 и task3. В случае, если какой-либо процесс завершится ошибкой, цепочка прервется.

## Управление приоритетом через параметры.

В качестве параметра можно передать не только явное значение, но и результат выполнения задачи. В этом случае DPE попытается автоматически построить корректный граф исполнения,если этого сделать не удастся, то сигнал прервется с соответствующей ошибкой.

    ```json
    {
        "task1": {
            "arg1": 42
        },
        "task2": {
            "arg1": "$task1"
        },
        "task3": {
            "arg1": "$task1",
            "arg2": "$task2"
        }
    }
    ```
    
Сигнал выше эквивалентен следующему псевдо-коду:

```
const res1 = task1(42)
task3(res1, task2(res1))
```

## Управление приоритетом через триггеры

Предназначены для задания графа исполнения.

```json
{
    "task2": {
      "@before": "task1"
    },
    "task3": {
      "@after": "task1",
      "@target": true
    },
    "task1": {}
}
```

В данном случае сначала запустится task2, затем task1, затем task3. Триггеры задаются через одноименные теги.

## Теги

Теги - текстовые метки, начинающиеся с символа '@'.

## Тег @target

Указывает результат какой задачи следует считать результатом выполнения сигнала. В случае, если данным тегом помечено несколько задач, результатом сигнала будет словарь, содержащий результат выполнения каждой задачи в ресурсе '$result'. Например (все задачи возвращают первый переданный аргумент):

signal.json:
```json 
{
    "task1": {
        "@target": true,
        "value": 1
    },
    "task2": {
        "value": 2
    },
    "task3": {
        "@target": true
        "value": 3
    }
}
```

result.json
```json 
{
    "_cid": "<SOME SID>",
    "_pid": "<SOME PID>",
    "task1": {
        "$result": "1"
    },
    "task3": {
        "$result": "3"
    }
}
```

# REPL

Есть возможность подключиться к работающему процессу через сокет. Например используя SOCAT ```socat - UNIX-CONNECT:/tmp/process.sock``` . После подключения появится REPL в котором определены переменные core (текущее ядро) и service (текущая задача)

# Справочник по командам

## DPE SERVICE

Набор команд для управления текущим узлом.

### start

Запускает службу DPE на текущем узле. В качестве дополнительных параметров принимает набор ядер (должны быть предварительно добавлены через dpe add), префикс (используется для логгирования) и порт (по-умолчанию 49001).

### stop

Останавливает службу.

### status

Вовзращает статус - запущена служба или нет.

### configure

Создаёт директорию .dpe в домашнем каталоге текущего пользователя. Там хранятся настройки сервиса и вспомогательные директории (включая логи).

### reset

Сбрасывает настройки сервиса (!) заменяя их настройками по-умолчанию.

## DPE APP 

### ADD

Добавление функций.

```bash
dpe app add -c -g https://domain.com/path/to.git name1
dpe app add -a -f ../path/to/directory/dpe.json name2
dpe app add -m -n npm-module-name name3
```

Опции:
-c, --core добавляет функции с уровнем исполнения ядра (возможно все)

-m, --module добавляет функции с уровнем исполнения модуля (нормальный)

-a, --app добавляет функции с уровнем исполнения приложения (песочница)

-g, --git получить зависимость из GIT, должен содержать dpe.json в корне

-f, --file загрузить локально dpe.json

-n, --npm получить из NPM

### CALL

Вызов метода (системного, либо определенного внутри компонента). Вызов может быть осуществлен как на локальном узле, так и на удаленном.

```bash
dpe app call 'client.list'
```

## DPE INIT

Используется для создания необходмых обвязок при создании своего компонента.

## DPE NET

Для подключения/отключения узлов. Используется, например, при масштабировании. Когда мы подняли несколько рабочих машин и хотим использовать их ресурсы для обработки сигнала. ВДля этого достаточно поднять на новых машинах DPE и подключить их к узлу, задачи которого требуют повышенных мощностей.

## DPE CLI

Загрузка сигнала в локальный или удаленный сервис.

```bash
dpe cli --file ./signal.json --url localhost --port 49001
```

# Как начать

1. Установить глобально npm пакет с фреймворком

    ```bash 
    sudo npm install -g dpe
    ```

1. Сконфигурировать сервис в системе (вызвать в любой директории)

    ```bash
    dpe service configure
    ```
1. Добавить зависимости

   
1. Запустить сервис с выбранными зависимостями

    ```bash
    dpe service start name1 name2
    ```
     

# FAQ

1. Как передать аргумент в функцию - dpe app call test -a "argName=argValue"

1. Как получить состояние процесса

    ```bash
    dpe app call process.state -a "pid=..."
    dpe app call process.list
    ```

1. Как остановить исполнение процесса

    ```bash
    dpe app call process.kill -a "pid=..."
    ```
    
1. Как определить свой набор функций?

    1. Создать приложение в требуемой директории

        ```bash
        dpe init
        ```
    1. Создать *.js файл с функцией

        ```bash
        touch test.js
        ```
        содержимое test.js

        ```javascript
        module.exports.A = function (env, args, callback) {
            console.log('HELLO WORLD!');
            callback(null, true);
        };
        ```
    1. Добавить его в dpe.json в этой же директории, файл должен выглядеть 
    следующим образом 

        ```javascript
        {
            "test": {
                "require": "./test.js"
            }
        }
        ```
    1. Добавить приложение в сервис (исполнять в директории приложения)

        ```bash
        dpe app add -a -f ./dpe.json
        ```
    
    1. Вызвать функцию

        ```bash
        dpe app call test.A
        ```

